# AppArmor profile for MEMSHADOW
# APT-Grade Container Security
# Classification: UNCLASSIFIED

#include <tunables/global>

profile memshadow flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/python>
  #include <abstractions/ssl_certs>
  #include <abstractions/openssl>

  # Application files (read-only)
  /app/** r,
  /app/*.py r,
  /app/**/*.py r,

  # Python virtual environment (read-only)
  /opt/venv/** r,
  /usr/lib/python3.11/** r,

  # Data directories (read-write with restrictions)
  /data/** rw,
  /app/logs/** rw,
  /app/missions/** rw,

  # Sensitive directories (controlled access)
  /app/exfil/** rw,
  /app/payloads/** rw,

  # Temporary files (restricted)
  /tmp/memshadow/** rw,
  owner /tmp/** rw,

  # Network access (restricted to application ports)
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,

  # PostgreSQL connection
  network tcp,

  # Redis connection
  network unix stream,

  # Deny dangerous capabilities
  deny capability sys_admin,
  deny capability sys_module,
  deny capability sys_rawio,
  deny capability sys_ptrace,
  deny capability dac_override,
  deny capability dac_read_search,
  deny capability fowner,
  deny capability fsetid,
  deny capability setuid,
  deny capability setgid,

  # Allow minimal required capabilities
  capability net_bind_service,
  capability chown,

  # Proc filesystem (limited)
  @{PROC}/@{pid}/stat r,
  @{PROC}/sys/kernel/random/uuid r,
  @{PROC}/sys/vm/overcommit_memory r,

  # Deny access to sensitive proc files
  deny @{PROC}/kcore r,
  deny @{PROC}/kmem r,
  deny @{PROC}/mem r,
  deny @{PROC}/sysrq-trigger w,

  # Deny access to other containers
  deny /var/lib/docker/** rw,
  deny /var/run/docker.sock rw,

  # Deny kernel module loading
  deny /lib/modules/** r,
  deny /sys/module/** r,

  # System libraries (read-only)
  /lib/** r,
  /usr/lib/** r,
  /lib64/** r,

  # Device access (very restricted)
  deny /dev/** rw,
  /dev/null rw,
  /dev/zero r,
  /dev/random r,
  /dev/urandom r,

  # Deny raw network access
  deny network raw,
  deny network packet,

  # Chromium (for web scraping, sandboxed)
  /usr/bin/chromium r,
  /usr/bin/chromium-browser r,
  /etc/chromium/** r,
  owner /tmp/.org.chromium.Chromium.** rw,

  # Deny shell access
  deny /bin/bash x,
  deny /bin/sh x,
  deny /usr/bin/sh x,

  # Allow Python execution
  /opt/venv/bin/python3 ix,
  /usr/bin/python3.11 ix,

  # Deny execution of other binaries
  deny /bin/** x,
  deny /usr/bin/** x,
  deny /usr/sbin/** x,
  deny /sbin/** x,
}
